# DEVLOG — 2026-02-24 테스트3 버그수정 패치

> **작성자**: Claude × 한솔
> **브랜치**: `claude/analyze-and-plan-EFRnF`
> **기반**: 배플로우 테스트3 체크리스트.md 피드백

---

## 수정 계획

### 왜 (Why)

Phase 0 긴급 안정화 이후 실제 앱 테스트(테스트3)에서 다수의 버그와 UX 문제가 발견됨:

1. **체크박스 빠른 토글 시 데이터 불일치** — race condition으로 시트에 잘못된 값 저장
2. **다중 씬 동시 단계 체크 미동작** — 50개 씬 선택 후 4단계 체크 시 일부만 반영
3. **아카이빙/해제 후 앱에서 안 보임** — 재시작해야 반영
4. **댓글 추가 시 즉시 미반영 + 중복** — API 완료까지 UI 변화 없어 여러 번 클릭
5. **AOT(항상 위) 미동작** — 다른 앱에 의해 가려짐
6. **사용자 CRUD 로딩 피드백 없음** — 추가/삭제 시 반응 없는 것처럼 보임
7. **대량 씬 추가 후 '데이터 없음' 깜빡임** — 동기화 완료 전 로딩 종료
8. **클릭/더블클릭 동작 혼란** — 클릭이 바로 상세 모달을 열어 선택 불가
9. **@멘션 키보드 선택 불가** — 마우스만 사용 가능
10. **Shift/Ctrl 선택 미지원** — 범위 선택 불가

### 무엇을 (What)

| # | 항목 | 심각도 |
|---|------|--------|
| 1 | 체크박스 토글 직렬화 큐 도입 | CRITICAL |
| 2 | 일괄 토글 `handleBulkToggle` 함수 분리 | CRITICAL |
| 3 | `syncInBackground` 아카이빙 목록 동시 갱신 | CRITICAL |
| 4 | EpisodeView 아카이빙 해제 후 `readAllFromSheets` 동기화 | CRITICAL |
| 5 | 댓글 낙관적 업데이트 + 중복 방지 + 로딩 스피너 | CRITICAL |
| 6 | AOT `floating` level 적용 | CRITICAL |
| 7 | 사용자 추가/삭제 로딩 상태 + 에러 처리 | UX |
| 8 | 대량 씬 `syncInBackground` await | UX |
| 9 | 클릭→선택, 더블클릭→상세모달 | UX |
| 10 | Shift+Click 범위 선택, Ctrl+Click 토글 | UX |
| 11 | @멘션 키보드 탐색 (↑↓ Enter) | UX |
| 12 | @멘션 태그 굵은 글씨 + 배경 하이라이트 | UX |
| 13 | 댓글 수정 저장/취소 버튼 우측 하단 버튼 형태로 | UX |
| 14 | 위젯 팝업 호버 영역 확대 | UX |
| 15 | 독 모드 텍스트 크기/여백 최적화 | UX |
| 16 | 데이터 로딩 중 스피너 표시 | UX |

### 어떻게 (How)

**1. 체크박스 race condition 해결**
- `toggleQueueRef = useRef<Promise<void>>` — 토글 요청을 큐에 넣어 순차 실행
- `useDataStore.getState()`로 최신 스토어 상태 직접 조회 (stale closure 방지)
- 각 `updateSheetCell` 호출이 이전 호출 완료 후에만 실행

**2. 아카이빙 즉시 반영**
- `syncInBackground()`에서 `readArchivedFromSheets()`도 동시 호출
- 기존: 로컬 `archivedEpisodes`로 필터링 → 새로운: 서버에서 최신 목록 조회
- EpisodeView: 아카이빙 해제 후 `readAllFromSheets()`로 활성 목록 즉시 갱신

**3. 댓글 낙관적 업데이트**
- `handleSubmit`: UI 먼저 업데이트 → 백그라운드 API 호출 → 실패 시 롤백
- `submitting` 상태로 전송 버튼 비활성화 (중복 방지)
- `handleEdit`/`handleDelete`도 동일 패턴 적용

**4. AOT floating level**
- `win.setAlwaysOnTop(aot, 'floating')` — Windows에서 안정적으로 항상 위 유지
- 팝업 생성 직후에도 `floating` level로 초기화

**5. 클릭 동작 변경**
- 단순 클릭: 씬 선택 토글 (Ctrl+Click과 동일)
- 더블클릭: 상세 모달 열기
- Shift+Click: `lastClickedIndexRef`와 현재 인덱스 사이 범위 선택

### 어떻게 작동하게 만드는지

- 체크박스 토글은 **큐 기반 순차 실행** → 빠르게 클릭해도 모든 요청이 순서대로 처리
- 아카이빙/해제는 **낙관적 UI + 서버 동기화** → 즉시 반영되고 서버 확인 후 확정
- 댓글은 **낙관적 + 중복 방지** → 버튼 클릭 즉시 UI 반영, 전송 중 재클릭 불가
- 위젯 팝업은 **floating AOT** → OS 레벨에서 다른 앱 위에 표시
- 씬 선택은 **클릭=선택, 더블클릭=상세, Shift=범위** → 표준 파일 탐색기 동작과 일치

---

## 패치 내역

### 수정 파일 목록

| 파일 | 변경 내용 |
|------|----------|
| `src/views/ScenesView.tsx` | 토글 큐, 일괄 토글, 아카이빙 동기화, 대량 씬 await, 클릭/더블클릭, Shift 범위 선택, 로딩 표시 |
| `src/views/EpisodeView.tsx` | 아카이빙 해제 후 readAllFromSheets, 아카이빙 실패 롤백 |
| `src/components/scenes/CommentPanel.tsx` | 낙관적 업데이트, 중복 방지, @멘션 키보드 탐색, 태그 시각 강화, 저장 버튼 UI |
| `src/components/auth/UserManagerModal.tsx` | 추가/삭제 로딩 상태, 에러 처리 |
| `src/views/WidgetPopup.tsx` | 호버 영역 확대, 독 텍스트 크기 |
| `electron/main.ts` | AOT floating level |

### 수정된 버그

1. **[CRITICAL] 체크박스 race condition**: `handleToggle`이 비동기 결과를 기다리지 않고 다음 호출 → `toggleQueueRef`로 순차 실행
2. **[CRITICAL] 다중 씬 동시 체크**: `forEach(handleToggle)` 병렬 실행 → 큐 기반으로 자동 직렬화
3. **[CRITICAL] 아카이빙 미반영**: `syncInBackground`가 로컬 `archivedEpisodes`로 필터링 → 서버에서 최신 목록 조회
4. **[CRITICAL] 댓글 중복**: `await addComment()` 완료 전 UI 미변경 → 낙관적 패턴 + `submitting` 가드
5. **[CRITICAL] AOT 미동작**: `setAlwaysOnTop(true)` → `setAlwaysOnTop(true, 'floating')`
6. **[UX] 대량 씬 '데이터 없음'**: `syncInBackground()` 미대기 → `await syncInBackground()`

### 테스트

| 검증 항목 | 결과 |
|-----------|------|
| `npx tsc --noEmit` | PASS — 타입 오류 없음 |
| `npx vite build` (renderer) | PASS |
| `npx vite build` (main) | PASS — 19.86KB |
| `npx vite build` (preload) | PASS — 4.06KB |

---

## 변경 통계

```
변경 파일: 6개
주요 변경: ~200줄 수정/추가
```

---

*다음 단계: 수정된 빌드로 테스트 4 진행*
