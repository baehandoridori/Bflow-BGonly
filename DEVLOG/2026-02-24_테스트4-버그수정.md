# 테스트4 버그수정

> **날짜**: 2026-02-24
> **범위**: 테스트4 체크리스트 [x] 대실패 + [q] 개선필요 항목 전체 수정

---

## 수정계획

### 왜?
테스트4에서 핵심 이슈가 남아있었음:
- 씬 다중선택 체크박스 토글이 개별 HTTP 요청으로 처리되어 50씬×4단계 = 200초 소요
- AOT(항상 위)가 완전히 동작하지 않아 위젯이 뜨자마자 숨김
- 독 모드가 깨진 UI로 표시됨
- 아카이빙 시 깜빡거리며 불안정

### 무엇을?
1. **대량 토글 성능**: 200개 개별 요청 → 1회 POST 요청으로 통합
2. **배치 20개 제한**: 클라이언트에서 자동 청킹
3. **AOT**: `ready-to-show` 이벤트 기반으로 재설계
4. **독 모드**: CSS `h-screen w-screen` → `w-full h-full`
5. **호버 영역**: `onMouseEnter` 핸들러 추가
6. **아카이빙**: readAllFromSheets 제거 (낙관적 상태 신뢰)
7. **UI**: 사용자 CRUD 낙관적, 카드 간격, 메모 색상, 사이드바 스크롤

### 어떻게?
- Apps Script에 `bulkUpdateCells` 신규 POST 액션 추가
- Electron IPC 파이프라인 구축 (sheets.ts → main.ts → preload.ts)
- `handleBulkToggle`을 단일 API 호출로 완전 재설계
- `batchToSheets`에 20개 초과 시 자동 분할 로직 추가

### 작동방식
- 50개 씬 선택 → 4단계 체크 → 각 단계별 1회 POST (총 4회) ← 기존 200회에서 극적 개선
- 대량 삭제 50개 → 3 chunk (20+20+10) 자동 분할
- AOT: 윈도우 ready 후 `setAlwaysOnTop(true, 'floating')` + 150ms 딜레이 후 재확인

---

## 패치내역

### 수정된 파일

| 파일 | 변경 |
|------|------|
| `apps-script/Code.gs` | `bulkUpdateCells` POST 액션 추가 — 단일 요청으로 여러 셀 업데이트 |
| `electron/sheets.ts` | `bulkUpdateCells()` 함수 추가 — POST 요청 |
| `electron/main.ts` | IPC `sheets:bulk-update-cells` 핸들러 + AOT `ready-to-show` 기반 재설계 |
| `electron/preload.ts` | `sheetsBulkUpdateCells` 메서드 expose |
| `src/services/sheetsService.ts` | `bulkUpdateCells()` + `batchToSheets` 자동 청킹 |
| `src/types/index.ts` | `sheetsBulkUpdateCells` 타입 선언 |
| `src/views/ScenesView.tsx` | `handleBulkToggle` 완전 재설계 + 카드 gap-3 + 메모 amber 색상 + 사이드바 overflow-y-auto |
| `src/views/WidgetPopup.tsx` | 독 모드 `w-full h-full` + `onMouseEnter` 핸들러 |
| `src/views/EpisodeView.tsx` | 아카이빙: readAll 제거, 언아카이빙: 낙관적 임시 에피소드 추가 |
| `src/components/auth/UserManagerModal.tsx` | 사용자 추가/삭제 낙관적 업데이트 |
| `src/components/scenes/EpisodeTreeNav.tsx` | 에피소드/파트 메모 amber 색상 |

### 수정된 버그

- **[C1/C2]** 체크박스 대량 토글 극도로 느림 → 1회 POST로 해결
- **[C3]** 아카이빙 → 깜빡거림 → readAllFromSheets 제거
- **[C4]** 아카이빙 해제 → 한참 뒤 복귀 → 낙관적 임시 에피소드 추가
- **[C7]** AOT 미동작 → ready-to-show 기반 + 딜레이 재확인
- **[U1/U2]** 사용자 추가/삭제 느림 → 낙관적 업데이트
- **[U10]** 호버 영역 바깥→내부 진입 미감지 → onMouseEnter 핸들러
- **[U11]** 독 모드 가로 스크롤바 → CSS w-full h-full
- **대량 삭제** batch max 20 → 자동 청킹
- 씬 카드 간격 좁음 → gap-3 (12px)
- 메모 색상 안 보임 → amber-400/70
- 사이드바 스크롤 짤림 → overflow-y-auto

### 테스트

- `npx tsc --noEmit` — PASS
- `npx vite build` — PASS (3개 번들 모두)
- main.js: 20.62 KB / index.js: 690.98 KB / preload.js: 4.14 KB

---

*작성: Claude × 한솔 (Studio JBBJ)*
