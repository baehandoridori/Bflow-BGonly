# Bflow 휴가관리 기능 구현 설계서

> **날짜:** 2026-02-27
> **목적:** Bflow에서 직접 휴가를 등록/취소/조회 — Slack 없이 Bflow 하나로 휴가 관리
> **현재 흐름:** Slack 워크플로 → Google Sheets(vacation-repo) → Google Calendar
> **목표 흐름:** Bflow도 동일 스프레드시트/캘린더에 접근 (Slack 기존 워크플로 유지)

---

## 아키텍처

```
[Bflow React] → IPC → [electron/main.ts] → HTTP → [vacation GAS Web App] → [Vacation Spreadsheet + Google Calendar]
                                                                                    ↑
[Slack Workflow] ─────────────── (기존 onEdit 트리거) ──────────────────────────────┘
```

- vacation GAS Web App은 Bflow의 Code.gs와 **별도** 배포 (vacation-repo 스프레드시트에 바인딩)
- 스프레드시트 ID: `1GzeB5c5KhB4gtg-BJB7mqhF81NM89i5TPMsfPH_2RrU`
- 캘린더 ID: `c_9697dba3555bb91af291049eb5f2a64c5b37bdf2bfc9d3f5f2f6486dc6d27b02@group.calendar.google.com`

---

## 핵심 결정사항

1. vacation-repo에 새 파일 `WebApi.gs` 추가 (기존 코드 수정 없음)
2. 실제 스프레드시트(DASHBOARD_JBBJ) 데이터 사용 (localStorage 제거)
3. 설정(ProfileSection) + 캘린더(ScheduleView) 통합 UI
4. 5가지 휴가 종류: 연차, 오전반차, 오후반차, 대체휴가, 특별휴가
5. `VacationAutoexportAndUpdateDashboard()` 포함 `Utilities.sleep(5000)` → API 응답 10초+ → timeout 60초

---

## Phase 1: vacation-repo — WebApi.gs

### 파일: `vacation-tracker/scripts/WebApi.gs`

**doGet 엔드포인트:**
- `ping` — 연결 테스트
- `readStatus(name)` — DASHBOARD_JBBJ + 대휴관리시트에서 개인 현황
- `readLog(name, year?, limit?)` — Vacation Log에서 개인 이력
- `readAllEvents(year?)` — 전체 직원 활성 휴가(등록완료) 목록 (캘린더용)

**doPost 엔드포인트:**
- `register({name, type, startDate, endDate, reason})` — 새 행 append → 처리 체인 실행
- `cancel({name, rowIndex})` — type을 '취소'로 변경 → 처리 체인 실행

**register 로직:**
1. Vacation Log 마지막 행 다음에 append
2. A='o', B=name, C=type, D=startDate, E=endDate, F=reason
3. I열(vacation code) = `{slackId}{startDate}{endDate}{type}` (기존 형식)
4. `VacationAutoexportAndUpdateDashboard()` 직접 호출 (onEdit는 프로그래밍 방식에 작동 안 함)
5. 처리 후 H열(state) 확인하여 결과 반환

---

## Phase 2: Bflow Electron 레이어

### 2.1 `electron/gas-fetch.ts` (신규)
- sheets.ts에서 `gasFetch`, `gasFetchWithRetry`, retry 상수 추출
- sheets.ts와 vacation.ts 모두 여기서 import

### 2.2 `electron/vacation.ts` (신규)
```typescript
initVacation(url: string): Promise<boolean>
isVacationConnected(): boolean
readVacationStatus(name: string): Promise<VacationStatusResponse>
readVacationLog(name: string, year?: number, limit?: number): Promise<VacationLogEntry[]>
readAllVacationEvents(year?: number): Promise<VacationEvent[]>
registerVacation(data: RegisterRequest): Promise<VacationResult>
cancelVacation(name: string, rowIndex: number): Promise<VacationResult>
```

### 2.3 `electron/main.ts` (수정)
IPC 핸들러 추가: `vacation:connect`, `vacation:is-connected`, `vacation:read-status`, `vacation:read-log`, `vacation:read-all-events`, `vacation:register`, `vacation:cancel`

### 2.4 `electron/preload.ts` (수정)
electronAPI에 vacation 메서드 노출

---

## Phase 3: 프론트엔드 기반

### 3.1 `src/types/vacation.ts` (신규)
```typescript
type VacationType = '연차' | '오전반차' | '오후반차' | '대체휴가' | '특별휴가'
interface VacationStatus { name, totalDays, remainingDays, overuse, altVacationHeld/Used/Net, ... }
interface VacationLogEntry { rowIndex, name, type, startDate, endDate, reason, days, state }
interface VacationEvent { name, type, startDate, endDate }
interface VacationRegisterRequest { name, type, startDate, endDate, reason }
interface VacationResult { success, state, rowIndex? }
interface VacationConfig { webAppUrl: string }
```

### 3.2 `src/types/index.ts` — ElectronAPI에 vacation 메서드 추가
### 3.3 `src/types/calendar.ts` — 'vacation' 타입 추가, vacation 전용 필드
### 3.4 `src/services/vacationService.ts` (신규) — IPC 래퍼
### 3.5 `src/stores/useAppStore.ts` — vacationConnected, vacationConfig 추가

---

## Phase 4: UI 컴포넌트

### 4.1 `SheetsSection.tsx` — 휴가 API URL 입력 영역 추가
### 4.2 `VacationRegisterModal.tsx` (신규) — 글래스모피즘 모달, 5종류 선택, 날짜/사유 입력
### 4.3 `ProfileSection.tsx` — localStorage 대신 실제 데이터, 신청 버튼, 이력 목록
### 4.4 `ScheduleView.tsx` — 휴가 이벤트 로드/머지, 필터, 캘린더에서 직접 등록
### 4.5 `CalendarWidget.tsx` — vacation 필터, 휴가 도트/바 표시
### 4.6 `CalendarView.tsx` — 간트 차트에 휴가 이벤트 포함

---

## 수정 파일 목록

| # | 레포 | 파일 | 변경 유형 |
|---|------|------|-----------|
| 1 | vacation-repo | `vacation-tracker/scripts/WebApi.gs` | 신규 |
| 2 | Bflow-BGonly | `electron/gas-fetch.ts` | 신규 |
| 3 | Bflow-BGonly | `electron/vacation.ts` | 신규 |
| 4 | Bflow-BGonly | `electron/sheets.ts` | 수정 |
| 5 | Bflow-BGonly | `electron/main.ts` | 수정 |
| 6 | Bflow-BGonly | `electron/preload.ts` | 수정 |
| 7 | Bflow-BGonly | `src/types/vacation.ts` | 신규 |
| 8 | Bflow-BGonly | `src/types/index.ts` | 수정 |
| 9 | Bflow-BGonly | `src/types/calendar.ts` | 수정 |
| 10 | Bflow-BGonly | `src/services/vacationService.ts` | 신규 |
| 11 | Bflow-BGonly | `src/stores/useAppStore.ts` | 수정 |
| 12 | Bflow-BGonly | `src/components/settings/SheetsSection.tsx` | 수정 |
| 13 | Bflow-BGonly | `src/components/settings/ProfileSection.tsx` | 대폭 수정 |
| 14 | Bflow-BGonly | `src/components/vacation/VacationRegisterModal.tsx` | 신규 |
| 15 | Bflow-BGonly | `src/views/ScheduleView.tsx` | 수정 |
| 16 | Bflow-BGonly | `src/components/widgets/CalendarWidget.tsx` | 수정 |
| 17 | Bflow-BGonly | `src/views/CalendarView.tsx` | 수정 |

---

## 검증

1. `tsc --noEmit` — 타입 에러 없음
2. `vite build` — 빌드 성공
3. vacation-repo API 테스트: `?action=ping`, `?action=readStatus&name=장삐쭈(테스트용)`
4. SheetsSection: vacation URL 입력 → 연결 테스트 → "연결됨"
5. ProfileSection: 실제 현황 표시, 신청/취소 동작
6. ScheduleView: 캘린더에 휴가 이벤트 표시, 필터, 직접 등록
7. 기존 Slack 워크플로 정상 동작 확인
