# DEVLOG — 2026-02-24 Phase 0: 긴급 안정화 + 구조 개편

> **작성자**: Claude x 한솔
> **브랜치**: `claude/analyze-and-plan-EFRnF`
> **커밋 범위**: `ef6d094` ~ `6a7a033` (총 8커밋)

---

## 수정 계획

### 왜 (Why)

B flow 앱이 Google Sheets 단일 SSOT 체제로 전환되었으나, 기존 구조에 여러 안정성 문제가 있었다:

1. **시트 API 호출이 개별 요청**: 에피소드 추가 시 에피소드/파트/레지스트리가 각각 별도 HTTP 요청 → 느리고 부분 실패 위험
2. **에피소드/파트 상태 관리 부재**: AC_ 접두사로 아카이빙을 처리하던 방식이 불안정 → 중앙 레지스트리 필요
3. **댓글이 로컬 파일에만 저장**: 다중 PC 환경에서 댓글 동기화 불가
4. **사용자 계정이 로컬 파일**: users.dat가 PC별로 달라 계정 불일치 발생
5. **대량 씬 추가가 느림**: 70개 씬 추가 시 70번의 개별 API 호출 → 수십 초 소요
6. **테스트 모드 코드가 프로덕션에 잔존**: `if(sheetsConnected)/else` 분기가 30곳 이상 → 유지보수 부담

### 무엇을 (What)

Phase 0을 6단계로 나누어 순차 실행:

| Phase | 내용 |
|-------|------|
| 0-1 | 배치 엔드포인트 + 재시도 로직 + 낙관적 업데이트 롤백 |
| 0-2 | `_REGISTRY` 탭 도입 — 에피소드/파트 상태 중앙 관리 |
| 0-3 | `_COMMENTS` 탭 도입 — 댓글을 Google Sheets에 동기화 |
| 0-4 | `_USERS` 탭 도입 — 사용자 계정을 Google Sheets에 동기화 |
| 0-5 | 대량 씬 추가 최적화 — `setValues`로 70개도 1~2초 |
| 0-6 | 테스트 모드 완전 제거 — 1,007줄 삭제 |

추가로 내부 검수에서 발견된 버그 수정:
- 6개 핸들러 롤백 누락
- App.tsx loadData 연결 확인 누락
- WidgetPopup 연결 실패 시 빈 상태 폴백 누락
- 데드코드 정리

### 어떻게 (How)

**배치 엔드포인트**: GAS `doPost`에 `action=batch` 추가. 여러 액션을 하나의 HTTP 요청으로 묶어 전송. 클라이언트에서 `batchToSheets()` 호출.

**_REGISTRY**: GAS에 `readRegistry`, `archiveViaRegistry`, `unarchiveViaRegistry` 액션 추가. 시트에 `_REGISTRY` 탭 자동 생성. 에피소드/파트의 생성/삭제/아카이빙 상태를 행 단위로 관리.

**_COMMENTS**: 파트별 지연 로딩 (`loadPartComments`). 클라이언트에 `sheetPartCache` 맵으로 캐싱. CRUD는 `sheetsAddComment`/`sheetsEditComment`/`sheetsDeleteComment` IPC.

**_USERS**: `_USERS` 탭에 userId/name/password(Base64)/slackId/birthday/joinDate 저장. `migrateUsersToSheets()`로 기존 users.dat → 시트 마이그레이션.

**대량 씬 추가**: GAS에 `addScenes` 액션 추가 → 서버에서 `setValues`로 한 번에 쓰기. 클라이언트에서 5개 이상이면 서버 확인 후 반영 (낙관적 아님).

**테스트 모드 제거**: `testSheetService.ts` 삭제, 모든 `if(sheetsConnected)` 분기 제거, `isTestMode` 상태 제거, 테스트 IPC 핸들러 제거.

### 어떻게 작동하게 만드는지 (Expected Behavior)

- 모든 데이터 변경은 **낙관적 업데이트** → 즉시 UI 반영 → 백그라운드 시트 동기화 → 실패 시 스냅샷 롤백
- 에피소드/파트/씬의 생명주기는 `_REGISTRY` 탭이 단일 진실의 원천
- 댓글/사용자는 시트에 저장되어 다중 PC에서 동기화
- 앱은 항상 시트 연결 상태에서만 동작 (테스트 모드 없음)
- 시트 연결 끊김 시 자동 재연결 시도

---

## 패치 내역

### Phase 0-1: 배치 엔드포인트 / 재시도 / 롤백
**커밋**: `ef6d094`

| 수정 파일 | 변경 내용 |
|-----------|----------|
| `apps-script/Code.gs` | `action=batch` 핸들러 추가 |
| `electron/sheets.ts` | `gasBatch()` 함수 추가 — 여러 액션을 하나의 POST로 |
| `electron/main.ts` | `sheets:batch` IPC 핸들러 등록 |
| `electron/preload.ts` | `sheetsBatch` API 노출 |
| `src/types/index.ts` | `BatchAction`, `BatchResponse` 타입 정의 |
| `src/services/sheetsService.ts` | `batchToSheets()` 래퍼 함수 |

**버그 수정**: 개별 API 호출 시 부분 실패로 데이터 불일치 위험 → 배치로 원자적 실행
**작동 방식**: `batchToSheets([{action:'addEpisode',...}, {action:'addPart',...}])` → 하나의 HTTP POST → GAS에서 순차 실행 → 전체 결과 반환

---

### Phase 0-2: _REGISTRY 탭 도입
**커밋**: `ef6d094`

| 수정 파일 | 변경 내용 |
|-----------|----------|
| `apps-script/Code.gs` | `readRegistry`, `archiveViaRegistry`, `unarchiveViaRegistry` 액션 |
| `electron/sheets.ts` | `readRegistry()`, `archiveEpisodeViaRegistry()`, `unarchiveEpisodeViaRegistry()` |
| `electron/main.ts` | 레지스트리 IPC 핸들러 3개 |
| `electron/preload.ts` | 레지스트리 API 노출 |
| `src/services/sheetsService.ts` | 레지스트리 서비스 함수 |
| `src/views/EpisodeView.tsx` | 아카이빙을 `_REGISTRY` 기반으로 전환 |

**버그 수정**: AC_ 접두사 아카이빙이 탭 이름 변경에 의존 → 깨지기 쉬움 → `_REGISTRY` 탭의 행 데이터로 안정적 관리
**작동 방식**: `_REGISTRY` 탭에 `[type, episodeNumber, partId, sheetName, department, status, ...]` 행 저장. 아카이빙 시 `status=archived`, 해제 시 `status=active`.

---

### Phase 0-3: _COMMENTS 탭 도입
**커밋**: `a27a4dd`

| 수정 파일 | 변경 내용 |
|-----------|----------|
| `apps-script/Code.gs` | `readComments`, `addComment`, `editComment`, `deleteComment` 액션 |
| `electron/sheets.ts` | 댓글 CRUD 4개 함수 |
| `electron/main.ts` | 댓글 IPC 핸들러 4개 |
| `electron/preload.ts` | 댓글 API 노출 |
| `src/types/index.ts` | 댓글 IPC 타입 정의 |
| `src/services/commentService.ts` | 시트 모드 추가 — `sheetsMode` 플래그로 시트/로컬 분기 |
| `src/views/ScenesView.tsx` | `setCommentsSheetsMode(true)` 호출 |

**버그 수정**: 댓글이 로컬 `comments.json`에만 저장 → 다른 PC에서 볼 수 없음 → 시트 동기화로 해결
**작동 방식**: 파트별 지연 로딩 (`loadPartComments(sheetName)`) → `sheetPartCache`에 캐싱 → 파트 전환 시 캐시 무효화

---

### Phase 0-4: _USERS 탭 도입
**커밋**: `40757df`

| 수정 파일 | 변경 내용 |
|-----------|----------|
| `apps-script/Code.gs` | `readUsers`, `addUser`, `updateUser`, `deleteUser` 액션 |
| `electron/sheets.ts` | 사용자 CRUD 4개 함수 |
| `electron/main.ts` | 사용자 IPC 핸들러 4개 |
| `electron/preload.ts` | 사용자 API 노출 |
| `src/types/index.ts` | 사용자 IPC 타입 정의 |
| `src/services/userService.ts` | 시트 모드 추가 + `migrateUsersToSheets()` |

**버그 수정**: users.dat가 PC별로 달라 계정 불일치 → 시트 동기화로 해결
**작동 방식**: `_USERS` 탭에 사용자 정보 저장. 비밀번호는 Base64 인코딩. 기존 users.dat가 있으면 자동 마이그레이션.

---

### Phase 0-5: 대량 씬 추가 최적화
**커밋**: `bb07430`

| 수정 파일 | 변경 내용 |
|-----------|----------|
| `apps-script/Code.gs` | `addScenes` 액션 — `setValues`로 한 번에 쓰기 |
| `electron/sheets.ts` | `addScenes()` 함수 |
| `electron/main.ts` | `sheets:addScenes` IPC 핸들러 |
| `electron/preload.ts` | `sheetsAddScenes` API 노출 |
| `src/services/sheetsService.ts` | `addScenesToSheets()` 래퍼 |
| `src/views/ScenesView.tsx` | `handleBulkAddScenes()` — 5개 이상이면 서버 확인 후 반영 + 로딩 오버레이 |

**버그 수정**: 70개 씬 추가 시 70번 HTTP 요청 → 수십 초 소요 → `setValues` 1회로 1~2초
**작동 방식**: 클라이언트에서 씬 배열 전송 → GAS에서 `setValues`로 한 번에 시트에 쓰기 → 성공 후 `syncInBackground()`로 UI 동기화

---

### Phase 0-6: 테스트 모드 완전 제거
**커밋**: `a5b7d86`

| 수정 파일 | 변경 내용 | 삭제량 |
|-----------|----------|--------|
| `src/services/testSheetService.ts` | **파일 삭제** | -373줄 |
| `src/stores/useAppStore.ts` | `isTestMode`/`setTestMode` 제거 | |
| `src/App.tsx` | 테스트 import/fallback 제거 | |
| `src/views/ScenesView.tsx` | 30+ `if(sheetsConnected)` 분기 제거 | |
| `src/views/EpisodeView.tsx` | 테스트 분기 제거 | |
| `src/views/WidgetPopup.tsx` | 테스트 init/fallback 제거 | |
| `src/views/SettingsView.tsx` | 앱 모드 표시 제거 | |
| `src/components/layout/Sidebar.tsx` | TEST 배지 제거 | |
| `src/components/spotlight/SpotlightSearch.tsx` | 로컬 메타데이터 fallback 제거 | |
| `src/components/widgets/MyTasksWidget.tsx` | 테스트 분기 제거 | |
| `src/components/scenes/SceneDetailModal.tsx` | `isLiveMode` prop 제거 | |
| `src/utils/imageUtils.ts` | `isLiveMode` 매개변수 제거 | |
| `electron/main.ts` | 테스트 IPC 핸들러 제거 | |
| `electron/preload.ts` | 테스트 API 노출 제거 | |
| `src/types/index.ts` | 테스트 타입 제거 | |

**총 변경**: 16파일, -1,007줄 / +175줄
**버그 수정**: 프로덕션에 불필요한 테스트 코드 잔존 → 유지보수 부담 + 혼란 → 완전 제거
**작동 방식**: 앱은 항상 Google Sheets 연결 상태에서만 동작. 미연결 시 연결 화면 표시.

---

### 내부 검수: 낙관적 업데이트 롤백 + 데드코드 정리
**커밋**: `defbbf6`

4개 병렬 리뷰 에이전트로 전체 코드 검수 후 발견된 버그 수정:

| 수정 파일 | 변경 내용 | 심각도 |
|-----------|----------|--------|
| `src/views/ScenesView.tsx` | 6개 핸들러에 롤백 스냅샷 추가 | HIGH |
| `src/views/ScenesView.tsx` | `handleSheetError()` 공통 에러 핸들러 추출 | HIGH |
| `src/views/ScenesView.tsx` | `AddSceneForm` 미사용 `sheetName` prop 제거 | LOW |
| `src/App.tsx` | `loadData`에 `checkConnection()` + 재연결 시도 추가 | HIGH |
| `src/App.tsx` | 미사용 `DEFAULT_THEME_ID` 임포트 제거 | LOW |
| `src/views/WidgetPopup.tsx` | 시트 연결 실패 시 빈 상태 폴백 추가 | MEDIUM |
| `src/views/EpisodeView.tsx` | 미사용 `archiveInfo` 변수 제거 | LOW |
| `src/views/EpisodeView.tsx` | 미사용 `DEPARTMENTS` 임포트 제거 | LOW |
| `src/services/commentService.ts` | 미사용 `loadAllComments()` 함수 삭제 | LOW |

**수정된 버그**:
1. **[HIGH] 롤백 누락**: `handleAddPart`, `handleAddScene`, `handleDeleteScene`, `handleFieldUpdate`, `handleDeletePart`, `handleDeleteEpisode`가 실패 시 UI를 이전 상태로 복원하지 않았음 → `useDataStore.getState().episodes` 스냅샷 저장 후 catch에서 `setEpisodes(prev)` 복원
2. **[HIGH] 에러 처리 불일치**: 일부 핸들러만 `Unknown action` 체크 → `handleSheetError()` 공통 함수로 6개 핸들러 모두 일관된 에러 메시지
3. **[HIGH] loadData 연결 확인 없음**: `readAllFromSheets()` 직접 호출 → 미연결 시 런타임 에러 → `checkConnection()` 선행 확인 + 재연결 시도
4. **[MEDIUM] WidgetPopup 빈 상태 없음**: 연결 실패 시 `else` 분기 없어 위젯이 행(hang) → `setEpisodes([])` 폴백 추가

**테스트**:
- `npx tsc --noEmit` — 타입 오류 없음 확인
- `npx vite build` — 3개 번들(renderer, main, preload) 빌드 성공 확인
- 의도적 미수정 항목: `setCommentsSheetsMode(true)` 빈 deps (마운트 시점에 이미 연결됨 — 정상), `migrateUsersToSheets` 무음 실패 (논블로킹 — 의도적)

---

## 검증 결과

| 검증 항목 | 결과 |
|-----------|------|
| `npx tsc --noEmit` | PASS |
| `npx vite build` (renderer) | PASS — 686KB |
| `npx vite build` (main) | PASS — 20KB |
| `npx vite build` (preload) | PASS — 4KB |

---

## 변경 통계

```
총 커밋: 8개
변경 파일: ~25개
삭제: ~1,200줄+ (테스트 모드 코드 + 데드코드)
추가: ~800줄+ (배치/레지스트리/댓글/사용자/대량씬/롤백)
```

---

*다음 단계: `TEST_GUIDE.md` 체크리스트 기반으로 실제 앱 테스트 진행*
